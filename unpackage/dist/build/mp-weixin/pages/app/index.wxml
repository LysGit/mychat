<wxs module="cosmosMod">
// 起始y的坐标
var startY = 0
// 起始y的坐标
var startX = 0
// y轴移动距离
var top = 0
// 防止重复下拉刷新
var code = 0
// 防止重复向逻辑层交互
var mit = 0

function touchstart(event, ins) {
	console.log('touchstart');
	top = 0;
	if (code == 0) {
		mit = 0
		ins.callMethod('cosmosTrigger', 2);
		var touch = event.touches[0] || event.changedTouches[0]
		startY = touch.pageY
		startX = touch.pageX
	}
}

function end(newValue, oldValue, ownerInstance, instance) {
	console.log('end');
	console.log('selectComponent', ownerInstance.selectComponent('#cosmos-refresh-container'));

	// 收回
	ownerInstance.selectComponent('#cosmos-refresh-container').setStyle({
		'transform': 'translateY(0)',
		'transition': 'ease 0.3s'
	})
	// 停止转圈
	ownerInstance.selectComponent('#load-text').removeClass('anim-text-infinite')

	ownerInstance.selectComponent('#load-text').setStyle({
		'transform': 'scale(0)'
	})

	// 复原
	code = 0
}

function touchend(event, ins) {
	console.log('touchend');
	if (code == 0) {
		// let bottom = ins.selectComponent('#more-text').$el.offsetTop - event.instance.$vm.lastScrollTop;
		// console.log('天热搜图');



		// const query = wx.createSelectorQuery()
		// query.select('#more-text').boundingClientRect(function(res){
		// 	console.log(res);
		//   res.top // #the-id 节点的上边界坐标（相对于显示区域）
		// })

		// console.log('moretext',ins.select('#more-text'));
		// select('#the-id').boundingClientRect()
		// console.log('moretext',ins.selectComponent('#more-text').triggerEvent);
		// let bottom = ins.selectComponent('#more-text').$el.offsetTop - event.instance.$vm.lastScrollTop;
		// if(bottom<1500){
		// 	ins.callMethod('cosmosTrigger', 3);
		// }
		// 这里根据自己业务处理,小于60则不作操作
		if (top < 60) {
			ins.selectComponent('#cosmos-refresh-container').setStyle({
				'transform': 'translateY(0)',
				'transition': 'ease 0.3s'
			})

			ins.selectComponent('#load-text').setStyle({
				'transform': 'scale(0)'
			})
		} else {
			ins.selectComponent('#load-text').setStyle({
				'transform': 'scale(1)'
			})
			// 改变提示文字
			ins.callMethod('cosmosTrigger', 1);
			// 防止重复下拉
			code = 1
			ins.selectComponent('#cosmos-refresh-container').setStyle({
				// 成功刷新回弹的距离
				'transform': 'translateY(60px)',
				'transition': 'ease 0.3s',
				'padding-bottom': '60px',
			})
			ins.selectComponent('#load-text').addClass('anim-text-infinite')

		}
	} else {

	}


}

function touchmove(event, ins) {
	if (code == 0) {
		var touch = event.touches[0] || event.changedTouches[0]
		var pageY = touch.pageY
		var pageX = touch.pageX
		var vew = ins.selectComponent('#cosmos-refresh-container')
		var dataset = vew.getDataset();
		top = pageY - startY
		var lr = pageX - startX
		console.log('touchmove', lr);

		// 页面是否触底
		if (dataset.top == 0) {
			// 改变提示文字,且只会触发一次
			if (top > 60) {
				if (mit == 0) {
					ins.callMethod('cosmosTrigger', 0);
				}
				mit = 1
			}
			vew.setStyle({
				'transform': 'translateY(' + (top) + 'px)',
				'padding-bottom': top + 'px',
			})
			// console.log('top', top)
			ins.selectComponent('#load-text').setStyle({
				'transform': 'scale(' + (top > 100 ? 1 : top / 100) + ')'
			})
		} else {
			// 从长列表下拉上来 ,这里要实时更新起始位置
			startY = pageY
		}
	}
}
module.exports = {
	end: end,
	touchend: touchend,
	touchstart: touchstart,
	touchmove: touchmove,
}
</wxs>
<view class="moyi-bg-img"><view data-event-opts="{{[['tap',[['hideModal',['$event']]]]]}}" class="{{['cu-modal bottom-modal',modalName=='cosmosMore'?'show':'']}}" bindtap="__e"><view class="cu-dialog"><view class="cu-list menu text-center bg-black"><view data-event-opts="{{[['tap',[['feedback']]]]}}" class="cu-item cu-item-bottom" bindtap="__e"><view>举报</view></view><view class="cu-item cu-item-bottom"><view>取消</view></view></view></view></view><scroll-view class="{{['my-screen-swiper','shadow']}}" scroll-x scroll-left="{{tabScroll}}" scroll-with-animation="true"><block wx:for="{{barList}}" wx:for-item="item" wx:for-index="index" wx:key="index"><view class="{{['my-tab-item','text-xxl',currentTab==index?'active':'']}}" data-current="{{index}}" data-event-opts="{{[['tap',[['clickMenu',['$event']]]]]}}" bindtap="__e"><text class="{{['text-xxl',currentTab==index?'bg-':'text-gray',item.icon]}}"></text><view class="{{[currentTab==index?'':'text-gray ']}}" style="margin-top:2px;">{{item.label}}</view></view></block></scroll-view><preview vue-id="62ba9b2b-1" list="{{preview.list}}" show="{{preview.show}}" index="{{preview.index}}" bind:__l="__l"></preview><swiper class="list_content " duration="500" current="{{currentTab}}" data-event-opts="{{[['change',[['changeContent',['$event']]]]]}}" bindchange="__e"><swiper-item class="content-item "><view class="moyi-bg-img cu-bar top-title padding-bottom-sm" style="{{('padding-top:'+base.CustomBar+'px')}}"><view class="bar-text margin-left-sm text-white"><text>Cosmos</text></view></view><scroll-view class="padding-top	cosmos-scroll-view" change:prop="{{cosmosMod.end}}" prop="{{cosmos.propValue}}" data-top="{{cosmos.scrollTop}}" id="cosmos-refresh-container" scroll-y upper-threshold="50" bindtouchstart="{{cosmosMod.touchstart}}" bindtouchmove="{{cosmosMod.touchmove}}" bindtouchend="{{cosmosMod.touchend}}"><view class="load-text  anim-text-lePeek text-center text-gray" id="load-text"><block wx:for="{{base.title}}" wx:for-item="item" wx:for-index="index" wx:key="index"><text class="anim-text" style="{{('animation-delay:'+(200+index*100)+'ms;')}}">{{item}}</text></block></view><block wx:for="{{$root.l0}}" wx:for-item="item" wx:for-index="index" wx:key="index"><view data-event-opts="{{[['tap',[['cosmosOpen',[index]]]]]}}" class="cosmos-chat text-grey" bindtap="__e"><view class="flex margin-tb padding-lr-xls"><view data-event-opts="{{[['tap',[['',['$event']],['userOpen',[index]]]]]}}" class="cu-avatar round lg" style="{{('background-image:url('+item.$orig.avatar+');')}}" catchtap="__e"><image src="{{item.$orig.frame}}" mode="widthFix"></image></view><view class="margin-auto padding-lr-sm"><text class="padding-right-sm ">{{item.$orig.nickname}}</text><text class="{{['text-bold',item.$orig.gender==0?'text-pink  cuIcon-female':'text-blue  cuIcon-male']}}"></text></view><view class="flex-sub margin-auto"></view><view class="flex cosmos-time"><view class="text-grey ">{{item.m0}}</view></view></view><view class="cu-item cosmos-text margin-bottom-sm">{{''+item.$orig.text+''}}</view><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="padding-lr-xls" catchtap="__e"><block wx:if="{{item.$orig.images}}"><view class="{{['grid','margin-auto',item.$orig.images_arr.length==1?'':'col-3 grid-square']}}"><block wx:for="{{item.$orig.images_arr}}" wx:for-item="items" wx:for-index="indexs" wx:key="indexs"><view data-event-opts="{{[['tap',[['previews',['$0',indexs],[[['cosmosList','',index,'images_arr']]]]]]]}}" class="margin-tb-sm cosmos-image-item" bindtap="__e"><image class="cosmos-image-item-image" lazy-load src="{{items}}" mode="aspectFill"></image></view></block></view></block></view><view class="padding-lr-xls grid col-6 border-bottom "><view class="text-right"><text class="cuIcon-comment text-xl"></text></view><view class="margin-tb-auto margin-left-ss">{{''+(item.$orig.reviews>0?item.$orig.reviews:'')+''}}</view><view data-event-opts="{{[['tap',[['',['$event']],['like',[index]]]]]}}" class="text-right" catchtap="__e"><text class="{{[item.$orig.isLike?'cuIcon-likefill text-red':'cuIcon-like']}}"></text></view><view class="margin-tb-auto margin-left-ss">{{''+(item.$orig.likes>0?item.$orig.likes:'')+''}}</view><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="text-right" catchtap="__e"><text data-event-opts="{{[['tap',[['cosmosMoreOperate',[index]]]]]}}" class="cuIcon-more text-xl" bindtap="__e"></text></view></view><view class="cosmos-border"></view></view></block><view class="load-text  anim-text-lePeek text-center text-gray" id="more-text"><block wx:for="{{base.title}}" wx:for-item="item" wx:for-index="index" wx:key="index"><text class="anim-text" style="{{('animation-delay:'+(200+index*100)+'ms;')}}">{{item}}</text></block></view></scroll-view></swiper-item><swiper-item class="content-item" style="background-image:url(../../static/bg-img.jpg);"><view class="moyi-bg-img cu-bar top-title padding-bottom-sm" style="{{('padding-top:'+base.CustomBar+'px')}}"><view class="bar-text margin-left-sm text-white"><text>Message</text></view></view><scroll-view class="padding-top	cosmos-scroll-view" style="{{('padding-top:'+base.CustomBar+'px')}}" change:prop="{{cosmosMod.end}}" prop="{{cosmos.propValue}}" data-top="{{cosmos.scrollTop}}" id="cosmos-refresh-container" scroll-y upper-threshold="50" bindtouchstart="{{cosmosMod.touchstart}}" bindtouchmove="{{cosmosMod.touchmove}}" bindtouchend="{{cosmosMod.touchend}}"><block wx:if="{{!newMessageList.length}}"><view class="tips-msg margin-top-xl"><text class="cuIcon-message icon"></text><text class="margin">暂时没有新的消息</text></view></block><block wx:else><view class="cu-list menu-avatar"><block wx:for="{{$root.l1}}" wx:for-item="item" wx:for-index="index" wx:key="index"><view data-event-opts="{{[['tap',[['openChat',['$0'],[[['newMessageList','',index,'user']]]]]]]}}" class="cu-item" bindtap="__e"><block wx:if="{{item.$orig.user.avatar}}"><view class="cu-avatar round lg" style="{{'background-image:'+('url('+item.$orig.user.avatar+')')+';'}}"></view></block><block wx:else><view class="cu-avatar round lg" style="{{'background-image:'+('url('+base.avatar+')')+';'}}"></view></block><view class="content"><view class="text-grey">{{item.$orig.user.nickname}}</view><view class="text-gray text-sm tips-value">{{item.$orig.tips.value}}</view></view><view class="action"><view class="text-grey text-xs">{{item.m1}}</view><block wx:if="{{item.$orig.tips.count!=0}}"><view class="cu-tag round bg-red sm">{{item.$orig.tips.count>99?'99+':item.$orig.tips.count}}</view></block></view></view></block></view></block></scroll-view></swiper-item><swiper-item class="content-item" style="background-image:url(../../static/bg-img.jpg);"><view class="moyi-bg-img cu-bar top-title padding-bottom-sm" style="{{('padding-top:'+base.CustomBar+'px')}}"><view class="bar-text margin-left-sm text-white"><text>Contacts</text></view></view><scroll-view class="padding-top	cosmos-scroll-view" style="{{('padding-top:'+base.CustomBar+'px')}}" change:prop="{{cosmosMod.end}}" prop="{{cosmos.propValue}}" data-top="{{cosmos.scrollTop}}" id="cosmos-refresh-container" scroll-y upper-threshold="50" bindtouchstart="{{cosmosMod.touchstart}}" bindtouchmove="{{cosmosMod.touchmove}}" bindtouchend="{{cosmosMod.touchend}}"><view class="cu-list menu-avatar"><view data-event-opts="{{[['tap',[['openChat',['$0'],['userInfo']]]]]}}" class="cu-item contacts-list" bindtap="__e"><view class="cu-avatar round wh-100" style="{{'background-image:'+('url('+userInfo.avatar+'),url('+userInfo.avatar+')')+';'}}"></view><view class="content margin-left-sm"><view class="text-xl text-white">{{userInfo.nickname}}</view></view><view class="action"></view></view><block wx:for="{{contacts.list}}" wx:for-item="item" wx:for-index="index" wx:key="index"><block wx:if="{{item.state=='normal'}}"><view data-event-opts="{{[['tap',[['openChat',['$0'],[[['contacts.list','',index,'user']]]]]]]}}" class="cu-item contacts-list" bindtap="__e"><view class="cu-avatar round wh-100" style="{{'background-image:'+('url('+item.user.avatar+'),url('+base.avatar+')')+';'}}"></view><view class="content margin-left-sm"><view class="text-xl text-white">{{item.user.nickname}}</view></view><view class="action"></view></view></block></block></view></scroll-view></swiper-item><swiper-item class="content-item "><view class="user-bg " style="{{('padding-top:'+base.CustomBar+'px')}}"><view class="flex"><view class="cu-avatar xl round margin-left bg-white" style="{{('background-image:url('+userInfo.avatar+');')}}"></view><view class="bio-area"><view class="grid col-1"><view class="text-xl margin-bottom-sm">{{''+userInfo.nickname+''}}<text class="text-sm margin-left-sm">{{"ID:"+userInfo.id}}</text><view class="text-sm text-cut" style="width:500rpx;">{{userInfo.bio?userInfo.bio:'这家伙很懒，什么也没写！'}}</view></view></view></view></view></view><view class="cu-card margin-bottom-xl"><view class="cu-item shadow-warp bg-white"><view class="margin-top-sm margin-left">工具</view><view class="grid col-4 fixed padding-lr text-center"><view class="text-xxl padding-lr"><view class="text-xxl padding-tb-sm" style="position:relative;"><view data-event-opts="{{[['tap',[['clean']]]]}}" bindtap="__e"><text class="cuIcon-copy"></text><view class="text-sm margin-top-sm">清除缓存</view></view></view></view><navigator class="text-xxl padding-lr" url="../test/test"><view class="text-xxl padding-tb-sm" style="position:relative;"><view><text class="cuIcon-copy"></text><view class="text-sm margin-top-sm">测试页面</view></view></view></navigator><view class="text-xxl padding-lr"><view class="text-xxl padding-tb-sm" style="position:relative;"><view data-event-opts="{{[['tap',[['qie']]]]}}" bindtap="__e"><text class="cuIcon-copy"></text><view class="text-sm margin-top-sm">切换登陆</view></view></view></view><view class="text-xxl padding-lr"><view class="text-xxl padding-tb-sm" style="position:relative;"><view data-event-opts="{{[['tap',[['qie']]]]}}" bindtap="__e"><text class="cuIcon-copy"></text><view class="text-sm margin-top-sm">切换登陆</view></view></view></view></view></view><block wx:for="{{menuList}}" wx:for-item="item" wx:for-index="index" wx:key="index"><view class="cu-item shadow-warp bg-white"><view class="margin-top-sm margin-left">{{item.label}}</view><view class="grid col-4 fixed padding-lr text-center"><block wx:for="{{item.list}}" wx:for-item="items" wx:for-index="indexs" wx:key="indexs"><view class="text-xxl padding-lr"><view class="text-xxl padding-tb-sm" style="position:relative;"><view hidden="{{!(items.tag)}}" class="{{['cu-tag badge',items.url?'':'bg-grey']}}">{{items.tag}}</view><navigator url="{{items.url}}"><text class="{{[items.icon]}}"></text><view class="text-sm margin-top-sm">{{items.label}}</view></navigator></view></view></block></view></view></block></view></swiper-item></swiper></view>